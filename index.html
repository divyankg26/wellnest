
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NovaFix ‚Äì Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --waveA:#2196f3;
  --waveB:#ff9800;
  --primary:#2196f3;
  --accent:#ff9800;
  --glass:rgba(255,255,255,0.18);
  --text:#fff;
}

html,body{
  margin:0;
  height:100%;
  font-family:'Segoe UI',sans-serif;
  color:var(--text);
}

body{
  background:linear-gradient(120deg,var(--waveA),var(--waveB));
  background-size:200% 200%;
  animation:waveMove 8s ease-in-out infinite;
  overflow-x:hidden;
}

@keyframes waveMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

/* SPLASH */
#splash{
  position:fixed;
  inset:0;
  background:#FFFFFF;
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
  transition:opacity 1s ease, transform 1s ease;
}
#splash.hide{
  opacity:0;
  transform:translateY(-40px);
  pointer-events:none;
}
#splash img{
  width:450px;
  max-width:80%;
  animation:popIn 1.2s ease;
}
@keyframes popIn{
  from{opacity:0;transform:scale(.85)}
  to{opacity:1;transform:scale(1)}
}

/* SIGN-IN / SIGN-UP MODAL */
#signInModal {
  display: none; 
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
  z-index: 10000;
}
.modal-content {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(14px);
  padding: 40px;
  border-radius: 20px;
  text-align: center;
  width: 90%;
  max-width: 400px;
  color: #fff;
  box-shadow: 0 12px 30px rgba(0,0,0,0.3);
}
.modal-content input {
  width: 100%;
  margin: 10px 0;
  padding: 12px;
  border-radius: 12px;
  border: none;
  background: rgba(255,255,255,0.22);
  color: #fff;
  font-size: 16px;
}
.modal-content button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  background: linear-gradient(135deg,var(--primary),var(--accent));
  color: #fff;
  font-weight: bold;
  font-size: 16px;
}
.modal-content p {margin-top: 10px; font-size: 14px; cursor: pointer;}

/* HEADER */
header{
  text-align:center;
  padding:30px;
  background:var(--glass);
  backdrop-filter:blur(14px);
  border-radius:0 0 20px 20px;
  box-shadow:0 12px 30px rgba(0,0,0,.3);
  position:relative;
}
header h1{margin:0;color:var(--primary)}
header p{margin:6px 0 0}
#signOutBtn{
  position:absolute;
  right:20px;
  top:30px;
  padding:8px 14px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  background: linear-gradient(135deg,var(--accent),var(--primary));
  color:#fff;
  font-weight:bold;
  display:none;
}

/* DASHBOARD */
.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:24px;
  padding:24px;
  display:none;
}

/* CARD */
.card{
  background:var(--glass);
  backdrop-filter:blur(16px);
  border-radius:20px;
  padding:20px;
  box-shadow:0 16px 40px rgba(0,0,0,.3);
  display:flex;
  flex-direction:column;
  border:1px solid rgba(255,255,255,.25);
}
.card h2{margin-top:0;color:var(--primary)}

.input-group{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
}

input,select,textarea,button{
  padding:10px;
  border-radius:12px;
  border:none;
  background:rgba(255,255,255,.22);
  color:var(--text);
  font-family:inherit;
}

button{
  cursor:pointer;
  font-weight:bold;
  background:linear-gradient(135deg,var(--primary),var(--accent));
}

.chat,#moodLogs,#gratitudeLogs,#reminders,#taskList{
  flex-grow:1;
  overflow-y:auto;
  padding:8px;
  border-radius:12px;
  background:rgba(0,0,0,.15);
  margin-top:8px;
}

#taskList button,
#gratitudeLogs button{
  margin-left:12px;
}

.ai-header-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}

.ai-header-row h2{margin:0}

.ai-clear-btn{
  padding:6px 10px;
  border-radius:10px;
  font-size:12px;
}

.chat-message{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:8px;
  margin-bottom:8px;
  padding:8px 10px;
  border-radius:10px;
  background:rgba(255,255,255,.12);
}

.chat-text{
  font-size:14px;
  line-height:1.35;
  word-break:break-word;
}

.chat-edit-btn{
  padding:6px 10px;
  border-radius:10px;
  font-size:12px;
  white-space:nowrap;
}

.mood-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:8px;
  padding:8px 10px;
  border-radius:10px;
  background:rgba(255,255,255,.12);
}

.mood-item span{
  font-size:14px;
}

.mood-remove{
  padding:6px 10px;
  border-radius:10px;
  border:none;
  font-size:12px;
}

::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-thumb{background:var(--primary);border-radius:3px}
</style>
</head>
<body>

<audio id="reminderSound" src="https://image2url.com/r2/default/audio/1770462028211-e2a46d69-8e18-430d-971b-e111cf9254b9.mp3" preload="auto"></audio>

<!-- SPLASH -->
<div id="splash">
  <img src="https://gcdnb.pbrd.co/images/T3DLjTXN0F9N.jpg?o=1">
</div>

<!-- SIGN-IN / SIGN-UP MODAL -->
<div id="signInModal">
  <div class="modal-content">
    <h2 id="modalTitle">Welcome to NovaFix üåü</h2>
    <input id="usernameInput" type="text" placeholder="Enter username" style="display:none;">
    <input id="emailInput" type="email" placeholder="Enter email">
    <input id="passwordInput" type="password" placeholder="Enter password">
    <button id="actionButton" onclick="handleAuth()">Sign In</button>
    <p onclick="toggleAuth()"><span id="toggleText">Don't have an account? Sign Up</span></p>
    <p id="signInError" style="color:red; display:none;">Error message here!</p>
  </div>
</div>

<header>
  <h1>NovaFix</h1>
  <p>Mind ‚Ä¢ Body ‚Ä¢ Money ‚Ä¢ Music ‚Ä¢ Productivity</p>
<button id="signOutBtn" onclick="signOutUser()">Sign Out</button>
</header>

<div class="dashboard">

<!-- AI Companion -->
<div class="card">
<div class="ai-header-row">
<h2>ü§ñ AI Companion</h2>
<button class="ai-clear-btn" onclick="clearAiChats()">Clear</button>
</div>
<div class="chat" id="chat"></div>
<div class="input-group">
<input id="aiInput" placeholder="Talk to AI">
<button onclick="aiChat()">Talk</button>
</div>
</div>

<!-- Reminders -->
<div class="card">
<h2>‚è∞ Reminders</h2>
<div class="input-group">
<input id="reminderText" placeholder="Reminder">
<input type="number" id="reminderMinutes" placeholder="Minutes">
<button onclick="addReminder()">Set</button>
</div>
<ul id="reminders"></ul>
</div>

<!-- Tasks -->
<div class="card">
<h2>üìä Productivity</h2>
<div class="input-group">
<input id="task" placeholder="Task">
<button onclick="addTask()">Add</button>
</div>
<ul id="taskList"></ul>
</div>

<!-- Grocery Finance -->
<div class="card">
<h2>üßæ Grocery Financing</h2>
<input id="gCost" placeholder="Monthly ‚Çπ">
<input id="gMonths" placeholder="Months">
<input id="buffer" placeholder="Buffer %">
<button onclick="calculateFinance()">Plan</button>
<p id="financeResult"></p>
</div>

<!-- Mood Tracker -->
<div class="card">
<h2>üßò Mood Tracker</h2>
<select id="mood">
<option>üòä Happy</option>
<option>üòê Neutral</option>
<option>üòî Low</option>
</select>
<button onclick="saveMood()">Save</button>
<div id="moodLogs"></div>
</div>

<!-- Water -->
<div class="card">
<h2>üíß Water Intake</h2>
<input id="waterGoalInput" placeholder="Daily goal">
<button onclick="setWaterGoal()">Set Goal</button>
<input id="waterInput" placeholder="Glasses">
<button onclick="saveWater()">Track</button>
<p id="waterProgress"></p>
</div>

<!-- Sleep -->
<div class="card">
<h2>üí§ Sleep</h2>
<input id="sleepInput" placeholder="Hours">
<button onclick="saveSleep()">Save</button>
<p id="sleepResult"></p>
</div>

<!-- Wellness Music -->
<div class="card">
<h2>üéµ Wellness Music</h2>
<iframe style="border-radius:14px" src="https://open.spotify.com/embed/playlist/0Gwjm4uWLCSE7ZIiY6dK2X" width="100%" height="190"></iframe>
</div>

<!-- Time Traveller Mirror -->
<div class="card">
<h2>ü™û Time Traveller Mirror</h2>
<input id="futureTask" placeholder="Enter goal">
<button onclick="timeTraveller()">Check</button>
<div id="timeMirror"></div>
</div>

<!-- Motivational Quotes -->
<div class="card">
<h2>üí° Motivational Quotes</h2>
<p id="quoteDisplay"></p>
<button onclick="newQuote()">Inspire Me</button>
</div>

<!-- Gratitude Journal -->
<div class="card">
<h2>üôè Gratitude Journal</h2>
<textarea id="gratitudeInput" rows="3"></textarea>
<button onclick="saveGratitude()">Save</button>
<div id="gratitudeLogs"></div>
</div>

<!-- Daily Challenge -->
<div class="card">
<h2>üèÜ Daily Challenge</h2>
<p id="dailyChallenge"></p>
<button onclick="completeChallenge()">Complete</button>
<p id="challengeResult"></p>
</div>

</div>

<script type="module">
  // üî• Firebase Imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, serverTimestamp, deleteDoc, doc, updateDoc, setDoc, getDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
import { 
  getAuth, 
  createUserWithEmailAndPassword, 
  signInWithEmailAndPassword, 
  onAuthStateChanged, 
  signOut,
  updateProfile 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// üî• Your Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCirCkRGlsODEExB9VLVY08Zw7b84zm_Qc",
  authDomain: "novaafix-86912.firebaseapp.com",
  projectId: "novaafix-86912",
  storageBucket: "novaafix-86912.firebasestorage.app",
  messagingSenderId: "699084708640",
  appId: "1:699084708640:web:401f5d6990d818551e1545",
  measurementId: "G-WHHXFW3N7R"
};

// üî• Initialize Firebase
const app = initializeApp(firebaseConfig);
let analytics = null;
try {
  analytics = getAnalytics(app);
} catch (_) {}
const auth = getAuth(app);
const db = getFirestore(app);

// ---------- DOM REFERENCES ----------
const emailInput = document.getElementById("emailInput");
const passwordInput = document.getElementById("passwordInput");
const usernameInput = document.getElementById("usernameInput");
const splash = document.getElementById("splash");
const signInModal = document.getElementById("signInModal");
const dashboard = document.querySelector(".dashboard");
const signOutBtn = document.getElementById("signOutBtn");
const chat = document.getElementById("chat");
const aiInput = document.getElementById("aiInput");
const reminderText = document.getElementById("reminderText");
const reminderMinutes = document.getElementById("reminderMinutes");
const reminders = document.getElementById("reminders");
const task = document.getElementById("task");
const taskList = document.getElementById("taskList");
const gCost = document.getElementById("gCost");
const gMonths = document.getElementById("gMonths");
const buffer = document.getElementById("buffer");
const financeResult = document.getElementById("financeResult");
const mood = document.getElementById("mood");
const moodLogs = document.getElementById("moodLogs");
const waterGoalInput = document.getElementById("waterGoalInput");
const waterInput = document.getElementById("waterInput");
const waterProgress = document.getElementById("waterProgress");
const sleepInput = document.getElementById("sleepInput");
const sleepResult = document.getElementById("sleepResult");
const futureTask = document.getElementById("futureTask");
const timeMirror = document.getElementById("timeMirror");
const quoteDisplay = document.getElementById("quoteDisplay");
const gratitudeInput = document.getElementById("gratitudeInput");
const gratitudeLogs = document.getElementById("gratitudeLogs");

// ---------- SPLASH + AUTH CHECK ----------
document.body.style.overflow = "hidden";
let splashRemoved = false;

function hideSplash() {
  if (splashRemoved || !splash) return;
  splash.classList.add("hide");
  setTimeout(() => {
    if (!splashRemoved) {
      splash.remove();
      splashRemoved = true;
      document.body.style.overflow = "auto";
    }
  }, 1000);
}

try {
  onAuthStateChanged(auth, (user) => {
    hideSplash();

    setTimeout(() => {
      if (user) {
        dashboard.style.display = "grid";
        signOutBtn.style.display = "block";
        signInModal.style.display = "none";
        loadMoods(user.uid);
        loadAiChats(user.uid);
        loadTasks(user.uid);
        loadWaterData(user.uid);
        loadSleepData(user.uid);
        loadGratitude(user.uid);
      } else {
        signInModal.style.display = "flex";
        dashboard.style.display = "none";
        signOutBtn.style.display = "none";
        moodLogs.innerHTML = "";
        chat.innerHTML = "";
        taskList.innerHTML = "";
        gratitudeLogs.innerHTML = "";
        waterProgress.innerText = "";
        sleepResult.innerText = "";
        moodHistory.length = 0;
        waterHistory.length = 0;
        sleepHistory.length = 0;
        waterGoal = 0;
        waterGoalInput.value = "";
      }
    }, 1000); // match your splash transition
  });
} catch (_) {
  setTimeout(() => {
    hideSplash();
    signInModal.style.display = "flex";
    dashboard.style.display = "none";
    signOutBtn.style.display = "none";
  }, 1000);
}

setTimeout(hideSplash, 2000);

// ---------- COLOR WAVES ----------
const waves = [
  ["#2196f3","#ff9800"],
  ["#9c27b0","#03a9f4"],
  ["#ff5722","#4caf50"],
  ["#3f51b5","#e91e63"],
  ["#009688","#ffc107"]
];
let w = 0;
function updateWave(){
  document.documentElement.style.setProperty("--waveA", waves[w][0]);
  document.documentElement.style.setProperty("--waveB", waves[w][1]);
  document.documentElement.style.setProperty("--primary", waves[w][0]);
  document.documentElement.style.setProperty("--accent", waves[w][1]);
  w = (w + 1) % waves.length;
}
updateWave();
setInterval(updateWave, 8000);

// ---------- SIGN-IN / SIGN-UP ----------
let authMode="signin";
function toggleAuth(){
  authMode=authMode==="signin"?"signup":"signin";
  const title=document.getElementById("modalTitle");
  const button=document.getElementById("actionButton");
  const toggleText=document.getElementById("toggleText");
  const error=document.getElementById("signInError");
  error.style.display="none";
  if(authMode==="signup"){
    title.innerText="Create a NovaFix Account üåü";
    button.innerText="Sign Up";
    toggleText.innerText="Already have an account? Sign In";
    usernameInput.style.display = "block";
  } else {
    title.innerText="Welcome to NovaFix üåü";
    button.innerText="Sign In";
    toggleText.innerText="Don't have an account? Sign Up";
    usernameInput.style.display = "none";
  }
}

async function handleAuth() {
  const username = usernameInput.value.trim();
  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();
  const error = document.getElementById("signInError");

  if (!email || !password) {
    error.style.display = "block";
    error.innerText = "Email and password are required!";
    return;
  }

  if (authMode === "signup" && !username) {
    error.style.display = "block";
    error.innerText = "Username is required for sign up!";
    return;
  }

  try {
    if (authMode === "signup") {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      await updateProfile(userCredential.user, { displayName: username });
    } else {
      await signInWithEmailAndPassword(auth, email, password);
    }
  } catch (err) {
    error.style.display = "block";
    error.innerText = err.message;
  }
}

function signOutUser() {
  signOut(auth);
}

// ---------- DASHBOARD JS ----------
const moodHistory=[],waterHistory=[],sleepHistory=[];

// AI Companion
function escapeHtml(text) {
  return text
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function getUserName(user) {
  if (user?.displayName && user.displayName.trim()) return user.displayName.trim();
  if (user?.email) return user.email.split("@")[0];
  return "there";
}

function setChatText(textNode, text, isHtml) {
  if (isHtml) textNode.innerHTML = text;
  else textNode.textContent = text;
}

function renderChatMessage(role, messageText, isHtml, chatId, fieldName) {
  const row = document.createElement("div");
  row.className = "chat-message";

  const textNode = document.createElement("div");
  textNode.className = "chat-text";
  textNode.dataset.rawText = messageText;
  setChatText(textNode, `${role === "user" ? "You" : "AI"}: ${messageText}`, isHtml);

  row.append(textNode);

  if (role === "user") {
    const editBtn = document.createElement("button");
    editBtn.className = "chat-edit-btn";
    editBtn.textContent = "Edit";
    editBtn.onclick = () => editChatMessage(chatId, fieldName, textNode, role);
    row.append(editBtn);
  }

  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

async function editChatMessage(chatId, fieldName, textNode, role) {
  const currentText = textNode.dataset.rawText || "";
  const updatedText = prompt("Edit message", currentText);
  if (updatedText === null) return;

  const nextText = updatedText.trim();
  if (!nextText) {
    alert("Message cannot be empty.");
    return;
  }

  textNode.dataset.rawText = nextText;
  setChatText(textNode, `${role === "user" ? "You" : "AI"}: ${nextText}`, false);

  const user = auth.currentUser;
  if (!user || !chatId) return;

  try {
    const payload = { [fieldName]: nextText };
    if (fieldName === "aiResponse") payload.aiResponseIsHtml = false;
    await updateDoc(doc(db, "users", user.uid, "aiChats", chatId), payload);
  } catch (err) {
    console.error("Failed to edit chat message:", err);
    alert(`Could not save edit: ${err.message || "Unknown error"}`);
  }
}

function renderChatPair(entry) {
  renderChatMessage("user", entry.userMessage || "", false, entry.id, "userMessage");
  renderChatMessage("ai", entry.aiResponse || "", !!entry.aiResponseIsHtml, entry.id, "aiResponse");
}

async function loadAiChats(userId) {
  chat.innerHTML = "";

  try {
    const snapshot = await getDocs(collection(db, "users", userId, "aiChats"));
    const docs = snapshot.docs
      .map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }))
      .sort((a, b) => {
        const aTime = a.createdAt?.toMillis?.() ?? new Date(a.createdAt || 0).getTime();
        const bTime = b.createdAt?.toMillis?.() ?? new Date(b.createdAt || 0).getTime();
        return aTime - bTime;
      });

    docs.forEach((entry) => {
      renderChatPair(entry);
    });
  } catch (err) {
    console.error("Failed to load AI chat logs:", err);
  }
}

async function storeAiChat(userId, userMessage, aiResponse, aiResponseIsHtml) {
  try {
    const ref = await addDoc(
      collection(db, "users", userId, "aiChats"),
      {
        userMessage,
        aiResponse,
        aiResponseIsHtml,
        createdAt: serverTimestamp()
      }
    );
    return ref.id;
  } catch (err) {
    console.error("Failed to store AI chat:", err);
    return null;
  }
}

async function clearAiChats() {
  const user = auth.currentUser;
  if (!user) return;
  if (!confirm("Clear all AI conversations?")) return;

  try {
    const snapshot = await getDocs(collection(db, "users", user.uid, "aiChats"));
    await Promise.all(snapshot.docs.map((docSnap) => deleteDoc(docSnap.ref)));
    chat.innerHTML = "";
  } catch (err) {
    console.error("Failed to clear AI chats:", err);
    alert(`Could not clear chats: ${err.message || "Unknown error"}`);
  }
}

async function aiChat(){
  const input = aiInput.value.trim();
  if(!input) return;
  const user = auth.currentUser;
  if (!user) {
    alert("Please sign in first.");
    return;
  }

  let msg=input.toLowerCase();
  let response="";
  let responseIsHtml = false;

  if(msg.match(/hi|hello|hey/)) {
    const currentUser = getUserName(user);
    response = `Hey there! What's up, ${currentUser}? üòä`;
  }
  else if(msg.match(/who are you/)) response="I am your NovaFix wellness companion üå±";
  else if(msg.match(/analyze|analysis|report|conclude/)){
    if(moodHistory.length===0&&waterHistory.length===0&&sleepHistory.length===0){
      response="You haven‚Äôt logged enough data yet for analysis. Start with mood, water, or sleep üå±";
    } else {
      responseIsHtml = true;
      response="üìä <b>Your Wellness Analysis</b><br>";
      if(sleepHistory.length){const lastSleep=sleepHistory[sleepHistory.length-1];response+=`üí§ Sleep: ${lastSleep} hrs<br>`;}
      if(waterHistory.length){const totalWater=waterHistory.reduce((a,b)=>a+b,0);response+=`üíß Water today: ${totalWater} glasses<br>`;}
      if(moodHistory.length){const lastMood=moodHistory[moodHistory.length-1];response+=`üßò Mood: ${lastMood}<br>`;}
      response+="<br>‚ú® Tip: Consistency beats intensity. Hydrate well, protect sleep, and track mood daily.";
    }
  } else response="I‚Äôm listening üåø Tell me about your mood, energy, or type *analyze* to see your wellness report.";

  const chatId = await storeAiChat(user.uid, input, response, responseIsHtml);
  renderChatPair({
    id: chatId,
    userMessage: input,
    aiResponse: response,
    aiResponseIsHtml: responseIsHtml
  });
  aiInput.value="";
}

// Reminders
function addReminder() {
  const t = reminderText.value.trim();
  const m = +reminderMinutes.value;
  if (!t || m <= 0) return;

  const li = document.createElement("li");
  reminders.appendChild(li);
  let s = m * 60;

  const audio = document.getElementById("reminderSound");

  const i = setInterval(() => {
    if (s <= 0) {
      clearInterval(i);
      li.textContent = `${t} ‚Äì Time's up!`;
      if(audio) audio.play(); // üîä Play your custom sound
      return;
    }
    li.textContent = `${t} ‚Äì ${Math.floor(s / 60)}m ${s % 60}s`;
    s--;
  }, 1000);

  reminderText.value = "";
  reminderMinutes.value = "";
}

// Tasks
function renderTask(entry) {
  const li = document.createElement("li");
  const span = document.createElement("span");
  span.textContent = entry.text;

  const editBtn = document.createElement("button");
  editBtn.textContent = "‚úèÔ∏è";
  editBtn.onclick = async () => {
    const newText = prompt("Edit task", span.textContent);
    if (!newText || !newText.trim()) return;
    span.textContent = newText.trim();

    const user = auth.currentUser;
    if (!user || !entry.id) return;
    try {
      await updateDoc(doc(db, "users", user.uid, "tasks", entry.id), { text: newText.trim() });
    } catch (err) {
      console.error("Failed to edit task:", err);
      alert(`Could not update task: ${err.message || "Unknown error"}`);
    }
  };

  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "üóëÔ∏è";
  deleteBtn.onclick = async () => {
    const user = auth.currentUser;
    if (!user || !entry.id) {
      li.remove();
      return;
    }
    try {
      await deleteDoc(doc(db, "users", user.uid, "tasks", entry.id));
      li.remove();
    } catch (err) {
      console.error("Failed to delete task:", err);
      alert(`Could not delete task: ${err.message || "Unknown error"}`);
    }
  };

  li.append(span, editBtn, deleteBtn);
  taskList.appendChild(li);
}

async function loadTasks(userId) {
  taskList.innerHTML = "";
  try {
    const snapshot = await getDocs(collection(db, "users", userId, "tasks"));
    const docs = snapshot.docs
      .map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }))
      .sort((a, b) => {
        const aTime = a.time?.toMillis?.() ?? new Date(a.time || 0).getTime();
        const bTime = b.time?.toMillis?.() ?? new Date(b.time || 0).getTime();
        return aTime - bTime;
      });
    docs.forEach((entry) => renderTask(entry));
  } catch (err) {
    console.error("Failed to load tasks:", err);
  }
}

async function addTask(){
  const user = auth.currentUser;
  if (!user) {
    alert("Please sign in first.");
    return;
  }

  const t=task.value.trim();
  if(!t)return;

  try {
    const ref = await addDoc(collection(db, "users", user.uid, "tasks"), {
      text: t,
      time: serverTimestamp()
    });
    renderTask({ id: ref.id, text: t, time: new Date() });
    task.value="";
  } catch (err) {
    console.error("Failed to save task:", err);
    alert(`Could not save task: ${err.message || "Unknown error"}`);
  }
}

// Finance
function calculateFinance(){
  const cost = parseFloat(gCost.value) || 0;
  const months = parseFloat(gMonths.value) || 1;
  const buf = parseFloat(buffer.value) || 0;

  const total = cost * months * (1 + buf/100);
  const monthly = total / months;

  financeResult.innerText = `Total: ‚Çπ${total.toFixed(0)} | Monthly: ‚Çπ${monthly.toFixed(0)}`;
}

// Mood
function renderMoodLog(entry) {
  const moodRow = document.createElement("div");
  moodRow.className = "mood-item";

  const moodLabel = document.createElement("span");
  const rawTime = entry.time?.toDate?.() ?? new Date(entry.time || Date.now());
  moodLabel.textContent = `${rawTime.toLocaleTimeString()} - ${entry.mood}`;

  const removeBtn = document.createElement("button");
  removeBtn.className = "mood-remove";
  removeBtn.textContent = "Remove";
  removeBtn.onclick = () => deleteMoodLog(entry.id, moodRow, entry.mood);

  moodRow.append(moodLabel, removeBtn);
  moodLogs.appendChild(moodRow);
}

async function deleteMoodLog(moodId, moodElement, moodValue) {
  const user = auth.currentUser;
  if (!user || !moodId) return;

  try {
    await deleteDoc(doc(db, "users", user.uid, "moods", moodId));
    moodElement.remove();
    const moodIndex = moodHistory.findIndex((m) => m === moodValue);
    if (moodIndex >= 0) moodHistory.splice(moodIndex, 1);
  } catch (err) {
    console.error("Failed to remove mood:", err);
    alert(`Could not remove mood: ${err.message || "Unknown error"}`);
  }
}

async function loadMoods(userId) {
  moodLogs.innerHTML = "";
  moodHistory.length = 0;

  try {
    const snapshot = await getDocs(collection(db, "users", userId, "moods"));
    const docs = snapshot.docs
      .map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }))
      .sort((a, b) => {
        const aTime = a.time?.toMillis?.() ?? new Date(a.time || 0).getTime();
        const bTime = b.time?.toMillis?.() ?? new Date(b.time || 0).getTime();
        return aTime - bTime;
      });

    docs.forEach((entry) => {
      moodHistory.push(entry.mood);
      renderMoodLog(entry);
    });
  } catch (err) {
    console.error("Failed to load mood logs:", err);
  }
}

async function saveMood() {
  const user = auth.currentUser;
  if (!user) {
    alert("Please sign in first.");
    return;
  }

  const moodValue = mood.value;

  try {
    const moodRef = await addDoc(
      collection(db, "users", user.uid, "moods"),
      {
        mood: moodValue,
        uid: user.uid,
        email: user.email || null,
        time: serverTimestamp()
      }
    );

    moodHistory.push(moodValue);
    renderMoodLog({ id: moodRef.id, mood: moodValue, time: new Date() });
  } catch (err) {
    console.error("Firestore write failed:", err);
    alert(`Could not save mood: ${err.message || "Unknown error"}`);
  }
}

// Water
let waterGoal=0;
function updateWaterProgress() {
  const sum = waterHistory.reduce((a, b) => a + b, 0);
  const percent = waterGoal > 0 ? Math.round((sum / waterGoal) * 100) : 0;
  waterProgress.innerText = `${sum}/${waterGoal} (${percent}%)`;
}

async function setWaterGoal(){
  const user = auth.currentUser;
  waterGoal = +waterGoalInput.value || 0;
  updateWaterProgress();

  if (waterGoal > 0) {
    alert(`‚úÖ Water goal set to ${waterGoal} glasses.`);
  } else {
    alert("‚ÑπÔ∏è Water goal cleared.");
  }

  if (!user) return;
  try {
    await setDoc(doc(db, "users", user.uid, "settings", "water"), { goal: waterGoal }, { merge: true });
  } catch (err) {
    console.error("Failed to save water goal:", err);
    alert(`Could not save water goal: ${err.message || "Unknown error"}`);
  }
}

async function loadWaterData(userId) {
  waterHistory.length = 0;

  try {
    const waterSettings = await getDoc(doc(db, "users", userId, "settings", "water"));
    waterGoal = waterSettings.exists() ? (waterSettings.data().goal || 0) : 0;
    waterGoalInput.value = waterGoal || "";

    const snapshot = await getDocs(collection(db, "users", userId, "waterIntake"));
    const docs = snapshot.docs
      .map((docSnap) => docSnap.data())
      .sort((a, b) => {
        const aTime = a.time?.toMillis?.() ?? new Date(a.time || 0).getTime();
        const bTime = b.time?.toMillis?.() ?? new Date(b.time || 0).getTime();
        return aTime - bTime;
      });

    docs.forEach((entry) => {
      if (entry.glasses) waterHistory.push(entry.glasses);
    });

    updateWaterProgress();
  } catch (err) {
    console.error("Failed to load water intake:", err);
  }
}

async function saveWater() {
  const user = auth.currentUser;
  if (!user) {
    alert("Please sign in first.");
    return;
  }

  const v = +waterInput.value;
  if (!v) return; // ignore empty or 0 input

  waterHistory.push(v);

  try {
    await addDoc(collection(db, "users", user.uid, "waterIntake"), {
      glasses: v,
      time: serverTimestamp()
    });
    updateWaterProgress();
    waterInput.value = "";
  } catch (err) {
    console.error("Failed to save water intake:", err);
    alert(`Could not save water intake: ${err.message || "Unknown error"}`);
  }
}

// Sleep
async function loadSleepData(userId) {
  sleepHistory.length = 0;
  sleepResult.innerText = "";

  try {
    const snapshot = await getDocs(collection(db, "users", userId, "sleepLogs"));
    const docs = snapshot.docs
      .map((docSnap) => docSnap.data())
      .sort((a, b) => {
        const aTime = a.time?.toMillis?.() ?? new Date(a.time || 0).getTime();
        const bTime = b.time?.toMillis?.() ?? new Date(b.time || 0).getTime();
        return aTime - bTime;
      });

    docs.forEach((entry) => {
      if (entry.hours) sleepHistory.push(entry.hours);
    });

    if (sleepHistory.length) {
      const latest = sleepHistory[sleepHistory.length - 1];
      sleepResult.innerText = `${latest} hrs üí§`;
    }
  } catch (err) {
    console.error("Failed to load sleep logs:", err);
  }
}

async function saveSleep(){
  const user = auth.currentUser;
  if (!user) {
    alert("Please sign in first.");
    return;
  }

  const hours = +sleepInput.value;
  if (!hours) return;

  sleepHistory.push(hours);
  sleepResult.innerText = `${hours} hrs üí§`;

  try {
    await addDoc(collection(db, "users", user.uid, "sleepLogs"), {
      hours,
      time: serverTimestamp()
    });
    sleepInput.value = "";
  } catch (err) {
    console.error("Failed to save sleep log:", err);
    alert(`Could not save sleep log: ${err.message || "Unknown error"}`);
  }
}

// Time Mirror
function timeTraveller(){const task=futureTask.value.trim();if(!task)return alert("Enter a task or goal.");timeMirror.innerHTML=`<p>‚ú® Future if you do it: You feel accomplished and energized after completing "${task}". üí™</p><p>üí§ Future if you skip it: You feel regret and a missed opportunity after ignoring "${task}". üòî</p>`;futureTask.value=""}

// Quotes
const quotes=["üå± 'The journey of a thousand miles begins with one step.' ‚Äì Lao Tzu","üí™ 'Your body can stand almost anything. It‚Äôs your mind that you have to convince.'","‚òÄÔ∏è 'Every morning we are born again. What we do today matters most.' ‚Äì Buddha","üåü 'Success is the sum of small efforts repeated day in and day out.' ‚Äì Robert Collier","üßò 'Happiness is not something ready-made. It comes from your own actions.' ‚Äì Dalai Lama","üî• 'Don‚Äôt watch the clock; do what it does. Keep going.' ‚Äì Sam Levenson"];
function newQuote(){quoteDisplay.innerText=quotes[Math.floor(Math.random()*quotes.length)];}
newQuote();

// Gratitude
function renderGratitude(entry) {
  const row = document.createElement("div");
  const rawTime = entry.time?.toDate?.() ?? new Date(entry.time || Date.now());

  const label = document.createElement("span");
  label.textContent = `${rawTime.toLocaleTimeString()} - ${entry.text}`;

  const editBtn = document.createElement("button");
  editBtn.textContent = "‚úèÔ∏è";
  editBtn.onclick = async () => {
    const nextText = prompt("Edit gratitude", entry.text || "");
    if (!nextText || !nextText.trim()) return;

    const user = auth.currentUser;
    if (!user || !entry.id) return;

    try {
      await updateDoc(doc(db, "users", user.uid, "gratitudeLogs", entry.id), {
        text: nextText.trim()
      });
      entry.text = nextText.trim();
      label.textContent = `${rawTime.toLocaleTimeString()} - ${entry.text}`;
    } catch (err) {
      console.error("Failed to edit gratitude log:", err);
      alert(`Could not update gratitude log: ${err.message || "Unknown error"}`);
    }
  };

  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "üóëÔ∏è";
  deleteBtn.onclick = async () => {
    const user = auth.currentUser;
    if (!user || !entry.id) {
      row.remove();
      return;
    }

    try {
      await deleteDoc(doc(db, "users", user.uid, "gratitudeLogs", entry.id));
      row.remove();
    } catch (err) {
      console.error("Failed to delete gratitude log:", err);
      alert(`Could not delete gratitude log: ${err.message || "Unknown error"}`);
    }
  };

  row.append(label, editBtn, deleteBtn);
  gratitudeLogs.appendChild(row);
}

async function loadGratitude(userId) {
  gratitudeLogs.innerHTML = "";

  try {
    const snapshot = await getDocs(collection(db, "users", userId, "gratitudeLogs"));
    const docs = snapshot.docs
      .map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }))
      .sort((a, b) => {
        const aTime = a.time?.toMillis?.() ?? new Date(a.time || 0).getTime();
        const bTime = b.time?.toMillis?.() ?? new Date(b.time || 0).getTime();
        return aTime - bTime;
      });

    docs.forEach((entry) => renderGratitude(entry));
  } catch (err) {
    console.error("Failed to load gratitude logs:", err);
  }
}

async function saveGratitude(){
  const user = auth.currentUser;
  if (!user) {
    alert("Please sign in first.");
    return;
  }

  const t=gratitudeInput.value.trim();
  if(!t)return;

  try {
    const ref = await addDoc(collection(db, "users", user.uid, "gratitudeLogs"), {
      text: t,
      time: serverTimestamp()
    });
    renderGratitude({ id: ref.id, text: t, time: new Date() });
    gratitudeInput.value="";
  } catch (err) {
    console.error("Failed to save gratitude log:", err);
    alert(`Could not save gratitude log: ${err.message || "Unknown error"}`);
  }
}

// Daily Challenge
const dailyChallenges = [
  "Finish 1 small task you‚Äôve been putting off.",
  "Learn 1 new word or fact today.",
  "Clean or organize one small area of your room/desk.",
  "Write down 3 things you‚Äôre grateful for.",
  "Smile at 3 people today.",
  "Avoid social media for 1 hour.",
  "Try a new hobby for 15 minutes.",
  "Drink 1 extra glass of water today.",
  "Take a 5-minute stretch break every 2 hours.",
  "Eat a fruit or vegetable with every meal.",
  "Meditate for 5‚Äì10 minutes."
];

// ---------- Function to pick a random daily challenge ----------
function pickDailyChallenge() {
  const challenge = dailyChallenges[Math.floor(Math.random() * dailyChallenges.length)];
  const dailyChallengeElement = document.getElementById("dailyChallenge");
  const challengeResultElement = document.getElementById("challengeResult");
  dailyChallengeElement.innerText = challenge;
  challengeResultElement.innerText = ""; // clear previous completion
}

// Initialize daily challenge on page load
pickDailyChallenge();

// Complete challenge function
function completeChallenge() {
  const challengeResultElement = document.getElementById("challengeResult");
  challengeResultElement.innerText = "‚úÖ Challenge completed! Great job!";
}

Object.assign(window, {
  handleAuth,
  toggleAuth,
  signOutUser,
  aiChat,
  clearAiChats,
  addReminder,
  addTask,
  calculateFinance,
  saveMood,
  setWaterGoal,
  saveWater,
  saveSleep,
  timeTraveller,
  newQuote,
  saveGratitude,
  completeChallenge
});

</script>
</body>
</html>
